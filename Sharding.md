# 데이터베이스 튜닝 (샤딩)

# 샤딩(Sharding)

- 샤딩이란, DB의 **데이터를 여러 시스템 환경에 분산하여 저장하는 기법**을 말한다.
- 일반적으로 시스템의 규모가 커지면, 단일 시스템에 모든 데이터를 저장하는 것은 **위험하며 동시에 성능이 감소한다.**
- 분산환경에서는 데이터베이스를 Shard(샤드)라는 최소 단위로 구분하여 분할한다.
    - 각 샤드는 중복데이터가 없이 저장된다.
    - 샤드는 DB나 시스템 마다 부르는 명칭은 조금씩 다르다 (Elasticsearch → Shard, HBase → Region)
    - 참고로 *중복되는 저장 데이터베이스는 샤드(Shard)가 아니라 레플리카(Replica, 복제본)로 칭한다.*

## 데이터 베이스의 규모 확장

일반적으로 데이터 베이스의 규모를 확장하기 위한 방식은 두가지가 있다.

### 수직적 확장 방식 (Scale Up)

- DB 인스턴스 자체의 물리적인 성능(CPU, 메모리, 디스크 용량) 을 높이는 방식
- 그러나 이 방식은 한계가 명확하다.
    - 물리적 리소스 증설은 한계가 있다.
    - SPOF가 된다.

### 수평적 확장 방식 (Scale Out)

- **샤딩과** 동일하다. DB의 물리적 인스턴스를 늘려서 분산된 환경을 구축하는 방식

## 샤딩의 장/단점

### 장점

- SPOF (Single Point of Failure, 단일 장애점)을 없애므로 가용성을 높일 수 있다.

  ![Untitled](https://user-images.githubusercontent.com/84346055/283535913-b8255199-f8d5-47ab-a720-89bb0c0882e8.png)

- 거대한 규모의 데이터에도 성능에 제약을 덜 받는다.
- 수직적 확장 방식과 비교해 확장의 규모가 크다.

### 단점

- **관리가 어렵고, 분산에 따른 부수효과(Side Effect)이 생긴다**
    - 데이터의 재샤딩 문제
        - 특정 샤드에 데이터가 많거나 분포가 균등하지 않은 경우 재배치 하는 문제
    - 핫스팟 키 문제
        - 특정 파티션 또는 샤드에 데이터가 몰리는 문제
    - 조인과 비정규화 문제
        - 여러 샤드간의 데이터를 조인하는 경우 생기는 문제


## 샤딩의 작동 방식

- 샤딩에서는 주어진 데이터를 **어느 샤드에 삽입 할 것**인지를 정하는 것이 중요하다.
- 여기서 어느 샤드에 삽입할지 정하는 키를 **샤딩키** 또는 **파티션키**라 한다.

## CAP 정리

- CAP 정리란
    - 분산 시스템의 특징 중 3가지인 Consistency(일관성), Availability(가용성), Partition tolerance(파티션 내구성)를 모두 만족하는 분산 시스템을 구현하는 것은 불가능하다는 정리

  ![Untitled](https://user-images.githubusercontent.com/84346055/283535936-e49f9788-a3c6-45a8-99fa-8b602abf4731.png)

    - 일관성
        - 어떠한 환경에서 데이터를 읽든 항상 일관된 결과를 보장
    - 가용성
        - 어떤 환경에서 장애가 나더라도 항상 데이터를 반환할 수 있도록 함
    - 파티션 내구성
        - 서로 다른 시스템간 통신에서 에러가 나더라도 계속 동작해야 한다.
- Consistency + Partition tolerance (CP 시스템)
    - 일관성과 파티션내구성을 보장하는 시스템
- Availability + Partition tolerance (AP 시스템)
    - 가용성과 파티션내구성을 보장하는 시스템
- Consistency + Availability (CA 시스템)
    - 일관성과 가용성을 보장하는 시스템, 그러나 일반적으로 이는 존재할 수 없다.
